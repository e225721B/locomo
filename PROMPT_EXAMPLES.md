# 発話生成プロンプト例

本ドキュメントでは、`generate_conversations.py` が最終的に LLM へ送信するプロンプトの具体例を示します。
2 つの異なる設定パターンを比較します。

---

## 設定パターン比較

| パターン                        | 想起 (Memory Stream) | 関係値内省 (Relationship Reflection) |
| ------------------------------- | -------------------- | ------------------------------------ |
| **A: 想起なし・関係値内省あり** | ❌                   | ✅                                   |
| **B: 想起あり・関係値内省なし** | ✅                   | ❌                                   |
| **C: 想起なし・関係値内省なし** | ❌                   | ❌                                   |

---

## パターン C: 想起なし・関係値内省なし（ベースライン）

**コマンド例:**

```bash
--session --reflection --memory-topk 3 --num-sessions 3 --exact-turns-per-session 10 \
--session-topics-file ./topics/relationship_senpai.json
```

### プロンプト構造

最もシンプルな構造で、過去のメモリ想起も関係値の注入もありません。

```
[ペルソナ]

[基本会話指示]

[言語指示 (日本語)]

[会話テーマ]

[会話履歴]
```

### 具体例 (セッション 1, ターン 3)

```text
田中健太は大学3年生で、サークルの副部長を務めている。明るく社交的な性格で、誰とでも
すぐに打ち解ける。趣味はバスケットボールと音楽鑑賞。将来はIT企業で働きたいと考えている。

田中健太 は 山田花子 と初めて会話します。今日は 2024年4月15日 です。あなたは 田中健太 に
なりきり、山田花子 に対して次に言う一言を書いてください。会話を始める場合は、相手の近況を
尋ねるか、最近あなたに起きた出来事について話してください。これまでの会話で共有した情報は
繰り返さないでください。会話は個人的で、家族・友人・好き嫌い・将来の希望などに触れてください。
'last Friday' や 'next month'、'when I was ten years old' のような時間参照や、具体的な
場所名を含めてください。返答は 20 語相当以内の短い一文で書いてください。例えば、

田中健太: 子どもの頃、母がよくパイナップルの誕生日ケーキを焼いてくれて大好きでした。

会話を終えるときは『Bye!』と書いてください。

CONVERSATION:

出力は必ず自然でカジュアルな日本語で、1発話のみ。括弧内の [END] 指示があればそのトークンも
含めて出力の末尾に付与してください。英語は使わないでください。
メタな説明（例:『〜と聞かれたことに対する返信』）は書かず、自然な発話の本文だけを出力してください。

会話のテーマ: 先輩と後輩の関係
このテーマに沿って自然に話題を展開してください。無理に繰り返さず、相手の発話に応じた自然な
一言で返答してください。

山田花子: こんにちは、田中先輩！サークルのことで相談があるんですけど...
田中健太: おお、花子か！何でも聞いてよ、俺で良ければ力になるよ。
山田花子:
```

### 特徴

- **LLM 呼び出し**: 発話生成のみ（1 回/ターン）
- **過去の参照**: セッション間のサマリーのみ（セッション 2 以降）
- **態度調整**: ペルソナと会話履歴から LLM が暗黙的に判断
- **用途**: ベースラインとの比較、シンプルな会話生成

---

## パターン A: 想起なし・関係値内省あり

**コマンド例:**

```bash
--session --reflection --memory-topk 3 --num-sessions 3 --exact-turns-per-session 10 \
--relationship-reflection --relationship-reflection-every-turn \
--session-topics-file ./topics/relationship_senpai.json
```

### プロンプト構造

```
[ペルソナ]

[基本会話指示]

[言語指示 (日本語)]

[会話テーマ]

[関係値内省 (Relationship Reflection)]

[会話履歴]
```

### 具体例 (セッション 1, ターン 3)

```text
田中健太は大学3年生で、サークルの副部長を務めている。明るく社交的な性格で、誰とでも
すぐに打ち解ける。趣味はバスケットボールと音楽鑑賞。将来はIT企業で働きたいと考えている。

田中健太 は 山田花子 と初めて会話します。今日は 2024年4月15日 です。あなたは 田中健太 に
なりきり、山田花子 に対して次に言う一言を書いてください。会話を始める場合は、相手の近況を
尋ねるか、最近あなたに起きた出来事について話してください。これまでの会話で共有した情報は
繰り返さないでください。会話は個人的で、家族・友人・好き嫌い・将来の希望などに触れてください。
'last Friday' や 'next month'、'when I was ten years old' のような時間参照や、具体的な
場所名を含めてください。返答は 20 語相当以内の短い一文で書いてください。例えば、

田中健太: 子どもの頃、母がよくパイナップルの誕生日ケーキを焼いてくれて大好きでした。

会話を終えるときは『Bye!』と書いてください。

CONVERSATION:

出力は必ず自然でカジュアルな日本語で、1発話のみ。括弧内の [END] 指示があればそのトークンも
含めて出力の末尾に付与してください。英語は使わないでください。
メタな説明（例:『〜と聞かれたことに対する返信』）は書かず、自然な発話の本文だけを出力してください。

会話のテーマ: 先輩と後輩の関係
このテーマに沿って自然に話題を展開してください。無理に繰り返さず、相手の発話に応じた自然な
一言で返答してください。

Relationship reflection (7-point -3..+3):
田中健太 -> 山田花子: Intimacy=1, Power=2
この値を参考に、親密度・力関係を調整してください。数値は -3(低)〜+3(高) です。

山田花子: こんにちは、田中先輩！サークルのことで相談があるんですけど...
田中健太: おお、花子か！何でも聞いてよ、俺で良ければ力になるよ。
山田花子:
```

### 関係値内省の意味

- **Intimacy (親密度) = 1**: やや親しい関係。くだけた口調も許容される。
- **Power (力関係) = 2**: 自分が優位な立場（先輩）。相手を導くような発言が期待される。

### 関係値内省の生成プロセスで使用されるプロンプト

関係値内省（Relationship Reflection）を生成するために、LLM に **2 回** プロンプトが投げられます。

#### ステップ 1: 高レベル質問 (HLQ) の生成

まず、直近のメモリから「この関係性を理解するための質問」を 3 つ生成させます。

**プロンプト例:**

```text
次の直近のメモリ（会話・気づきを含む）のみを根拠として、その中に登場する人物や出来事について
答えられる最も重要な高レベルの質問を3つ挙げてください。
出力は JSON 配列（要素は文字列）『のみ』で、ちょうど3件返してください。余計な文章は書かないでください。

直近メモリ:
- 山田花子: こんにちは、田中先輩！サークルのことで相談があるんですけど...
- 田中健太: おお、花子か！何でも聞いてよ、俺で良ければ力になるよ。
- 山田花子: 実は新入生歓迎会の準備で困っていて...
```

**期待される出力:**

```json
[
  "田中健太は山田花子にとってどのような存在か？",
  "山田花子は田中健太をどの程度信頼しているか？",
  "二人の間の上下関係はどのように表れているか？"
]
```

#### ステップ 2: 関係値の評価

HLQ をクエリとしてメモリから関連する証拠（Evidence）を取得した後、それらを基に関係値を評価します。

**プロンプト例:**

```text
以下の高レベル質問と番号付き根拠に基づいて、田中健太 から 山田花子 への関係値を 7 段階
（-3〜+3 の整数）で評価してください。
評価する指標は2つです:
- Intimacy: 親密度（田中健太 が 山田花子 に対して感じる近しさ・好意の度合い。高いほど親しい）
- Power: 力関係（田中健太 が 山田花子 に対して自分がより優位/影響力があると感じる度合い。
  高いほど 田中健太 が優位と感じる）

キャラクターのペルソナ:
- 田中健太: 大学3年生で、サークルの副部長を務めている。明るく社交的な性格で...
- 山田花子: 大学1年生で、サークルに入ったばかりの新入生。真面目で勉強熱心...

出力は JSON オブジェクトのみ（英語キー名厳守）: {"Intimacy":-3..+3,"Power":-3..+3}。
JSON 以外の文章は書かないでください。

高レベル質問:
- 田中健太は山田花子にとってどのような存在か？
- 山田花子は田中健太をどの程度信頼しているか？
- 二人の間の上下関係はどのように表れているか？

根拠（番号付き）:
1. 山田花子: こんにちは、田中先輩！サークルのことで相談があるんですけど...
2. 田中健太: おお、花子か！何でも聞いてよ、俺で良ければ力になるよ。
3. 山田花子: 実は新入生歓迎会の準備で困っていて...
```

**期待される出力:**

```json
{ "Intimacy": 1, "Power": 2 }
```

この結果が次のターンの発話生成プロンプトに `Relationship reflection` として注入されます。

---

## パターン B: 想起あり・関係値内省なし

**コマンド例:**

```bash
--session --reflection --memory-stream --memory-topk 3 --num-sessions 3 \
--exact-turns-per-session 10 --session-topics-file ./topics/relationship_senpai.json
```

### プロンプト構造

```
[ペルソナ]

[基本会話指示]

[言語指示 (日本語)]

[会話テーマ]

[想起されたメモリ (Memory Snippet)]

[会話履歴]
```

### 具体例 (セッション 2, ターン 5)

```text
田中健太は大学3年生で、サークルの副部長を務めている。明るく社交的な性格で、誰とでも
すぐに打ち解ける。趣味はバスケットボールと音楽鑑賞。将来はIT企業で働きたいと考えている。

田中健太 は 山田花子 と 2024年4月15日 に最後に話しました。

今日は 2024年5月20日 です。あなたは 田中健太 になりきり、山田花子 に対して次に言う一言を
書いてください。会話を始める場合は、相手の近況を尋ねる、以前の会話のフォローアップをする、
または相手が興味を持ちそうな最近の出来事を話してください。これまでに共有した情報は繰り返さ
ないでください。会話は個人的で、家族・友人・好き嫌い・将来の希望などに触れてください。
'last Friday' や 'next month'、'when I was ten years old' のような時間参照や、具体的な
場所名を含めてください。返答は 20 語相当以内の短い一文で書いてください。例えば、

田中健太: 子どもの頃、母がよくパイナップルの誕生日ケーキを焼いてくれて大好きでした。

会話を終えるときは『Bye!』と書いてください。

CONVERSATION:

出力は必ず自然でカジュアルな日本語で、1発話のみ。括弧内の [END] 指示があればそのトークンも
含めて出力の末尾に付与してください。英語は使わないでください。
メタな説明（例:『〜と聞かれたことに対する返信』）は書かず、自然な発話の本文だけを出力してください。

会話のテーマ: 先輩と後輩の関係
このテーマに沿って自然に話題を展開してください。無理に繰り返さず、相手の発話に応じた自然な
一言で返答してください。

[Retrieved Memory - top 3 by relevance]
- 山田花子: 田中先輩、この前のバスケの試合すごかったです！ (2024-04-15, importance=7)
- 田中健太: ありがとう！来月の大会も頑張るから応援よろしくな。 (2024-04-15, importance=6)
- 田中健太 は 山田花子 との会話で、サークルの新入生歓迎会について話し合った。 (reflection, 2024-04-15)

山田花子: 先輩、大会の結果どうでしたか？
田中健太:
```

### 想起メモリの特徴

- 過去のセッションから**関連性スコア**の高い記憶を最大 `memory-topk` 件取得
- **importance** 値と **recency** (時間減衰) も考慮してランキング
- 内省 (reflection) の結果も想起対象に含まれる

---

## パターン比較まとめ

| 項目               | パターン A (関係値内省あり)          | パターン B (想起あり)            | パターン C (ベースライン)          |
| ------------------ | ------------------------------------ | -------------------------------- | ---------------------------------- |
| **過去の会話参照** | なし（セッション間のサマリーのみ）   | 具体的な発話を想起               | なし（セッション間のサマリーのみ） |
| **態度調整**       | Intimacy/Power 数値で明示的に指示    | 想起内容から暗黙的に判断         | ペルソナ・履歴から暗黙的に判断     |
| **プロンプト長**   | 中程度                               | 想起件数に応じて増加             | 短い                               |
| **LLM 呼び出し**   | 3 回/ターン (HLQ + 評価 + 発話)      | 1 回/ターン                      | 1 回/ターン                        |
| **用途**           | 関係性の変化を明示的に制御したい場合 | 過去の文脈を詳細に活用したい場合 | ベースライン比較                   |

---

## 両方を組み合わせた場合

**コマンド例:**

```bash
--session --reflection --memory-stream --memory-topk 3 --num-sessions 3 \
--exact-turns-per-session 10 --relationship-reflection --relationship-reflection-every-turn \
--session-topics-file ./topics/relationship_senpai.json
```

この場合、プロンプトには**想起メモリ**と**関係値内省**の両方が含まれます：

```text
[ペルソナ]
[基本会話指示]
[言語指示]
[会話テーマ]
[想起メモリ]                    ← Memory Stream からの想起
[関係値内省]                    ← Intimacy/Power 数値
[会話履歴]
```

---

## 補足: 会話履歴の構造

プロンプトの末尾に付加される「会話履歴」は、現在のセッション内でこれまでに生成された発話を時系列で並べたものです。

### 会話履歴の構築ルール

1. **セッション開始時**: 話者名 + `:` のみ（例: `田中健太: `）
2. **各ターン後**: 生成された発話を追加し、次の話者名 + `:` を付与
3. **改行区切り**: 各発話は改行で区切られる

### 具体例: ターンごとの変化

#### ターン 0（セッション開始、田中健太が最初に話す）

```text
... (プロンプト本体) ...

田中健太:
```

#### ターン 1（田中健太の発話後、山田花子の番）

```text
... (プロンプト本体) ...

田中健太: こんにちは、花子！最近サークルどう？

山田花子:
```

#### ターン 2（山田花子の発話後、田中健太の番）

```text
... (プロンプト本体) ...

田中健太: こんにちは、花子！最近サークルどう？
山田花子: あ、先輩！実は新歓の準備で困ってて...

田中健太:
```

#### ターン 5（会話が進んだ状態）

```text
... (プロンプト本体) ...

田中健太: こんにちは、花子！最近サークルどう？
山田花子: あ、先輩！実は新歓の準備で困ってて...
田中健太: そっか、何か手伝えることある？
山田花子: えっと、会場のセッティングなんですけど...
田中健太: ああ、去年もやったから任せて！土曜日空いてるよ。

山田花子:
```

### 注意点

- **累積的**: 会話履歴はセッション内で累積され、ターンが進むほど長くなる
- **セッション区切り**: 新しいセッションが始まると履歴はリセットされる（ただし前セッションのサマリーは別途提供される場合あり）
- **トークン制限**: 履歴が長くなりすぎるとトークン制限に達する可能性があるため、`--max-turns-per-session` などで制御

---

## 補足: 関係値内省の更新タイミング

`--relationship-reflection-every-turn` オプションが有効な場合:

1. **ターン終了後**: 次の話者の関係値を再計算
2. **HLQ 生成**: 「この関係性を理解するための質問」を LLM が生成
3. **証拠収集**: Memory Stream から関連記憶を取得
4. **評価**: LLM が Intimacy/Power を -3〜+3 で採点
5. **更新**: 次のターンのプロンプトに反映

ログ出力例:

```
[rr/post] turn=3 updated for next speaker 山田花子: Intimacy=2, Power=-1
```
